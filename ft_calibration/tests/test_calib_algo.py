import numpy as np
from ft_calibration import FTCalibrator


def test_calib():
    calib = FTCalibrator()

    # each line is gx, gy, gz, fx, fy, fz, tx, ty, tz
    data = """-6.93651 -6.93688 0.0241249 -0.809967 -5.49514 1.66939 -0.523497 0.235421 -0.252396
-5.21137 -8.10183 -1.85422 -1.60583 -5.00072 3.09008 -0.563256 0.163582 -0.253131
-6.61366 -6.13303 3.85766 -0.84336 -6.06756 0.441889 -0.464605 0.221182 -0.251983
-8.11617 -4.07437 -3.70991 -0.0844877 -6.91135 3.48583 -0.391775 0.289743 -0.254852
-2.06511 -9.5454 0.925584 -3.01478 -4.41493 2.47878 -0.609576 0.0306915 -0.254364
-9.05762 -1.99744 3.19467 0.514828 -8.05371 0.467931 -0.282808 0.327144 -0.2553
-4.07723 -6.42066 -6.19576 -2.15806 -5.66913 4.82118 -0.50778 0.122517 -0.25312
-2.72324 -7.19516 6.08685 -2.5945 -5.6509 0.176383 -0.494868 0.0593089 -0.253269
-9.49523 0.143798 -2.46091 0.755844 -9.00226 2.85196 -0.197618 0.350419 -0.254678
0.565483 -9.35568 -2.89613 -3.9581 -4.64622 5.18878 -0.580198 -0.0734374 -0.260946
-6.47579 -1.75947 7.15574 -0.59943 -8.32659 -0.795588 -0.255611 0.219525 -0.254716
-5.57013 -2.08922 -7.80031 -1.1634 -7.89216 5.54714 -0.306971 0.190488 -0.256307
1.60798 -8.70906 4.21934 -4.47325 -5.06294 1.83148 -0.547032 -0.119557 -0.259551
-9.23981 2.70502 1.88279 0.787052 -10.3764 0.919 -0.078189 0.339106 -0.257555
0.625822 -6.59296 -7.23722 -4.45353 -5.66337 6.07049 -0.508109 -0.0771874 -0.249042
-1.87024 -3.52319 8.96245 -2.79611 -7.6075 -0.904395 -0.325929 0.0261696 -0.254767
-7.39323 2.55192 -5.92149 -0.091176 -10.1037 4.54001 -0.101434 0.268756 -0.258945
4.48007 -8.71935 -0.371486 -5.8404 -5.02698 4.28091 -0.554304 -0.236273 -0.258684
-6.58601 2.88662 6.67293 -0.340788 -10.6038 -0.735661 -0.0558171 0.228058 -0.257772
-1.2417 -1.88765 -9.54626 -3.32495 -7.59828 6.44978 -0.319134 0.00998324 -0.259808
3.08105 -5.6651 7.39255 -5.17529 -6.59266 0.486967 -0.415632 -0.181238 -0.25386
-7.80939 5.798 -1.27777 0.274825 -11.766 2.31372 0.0436299 0.286593 -0.258643
4.97411 -6.37738 -5.55188 -5.93447 -6.3246 7.07584 -0.441123 -0.262417 -0.262438
-1.93363 1.07625 9.55714 -2.55532 -9.94778 -1.35246 -0.125586 0.030425 -0.256237
-3.61095 3.2909 -8.50689 -1.93583 -10.4401 5.87255 -0.0787834 0.114542 -0.255146
6.74748 -6.47579 2.96171 -6.88798 -6.26367 2.82136 -0.452755 -0.334181 -0.256163
-5.86332 6.69614 4.12544 -0.577457 -12.4296 0.138782 0.0948663 0.201017 -0.25697
3.38431 -1.94242 -9.00053 -5.5663 -7.74998 6.4595 -0.32325 -0.185737 -0.240274
3.31719 -1.32822 9.13609 -5.62507 -8.46732 -1.71115 -0.278444 -0.190564 -0.235891
-4.73855 7.31916 -4.4958 -0.294511 -14.5175 5.65814 0.112765 0.212043 -0.265092
8.09103 -4.98325 -2.43694 -7.88623 -6.69387 4.54573 -0.434774 -0.388308 -0.237403
-1.76184 5.46583 7.95341 -2.87758 -11.893 -1.73872 0.0222704 0.0251209 -0.242579
1.02922 3.2384 -9.20269 -4.46704 -10.5794 6.5503 -0.092917 -0.0883031 -0.237435
7.55411 -2.74495 5.62465 -7.2942 -8.07828 1.16398 -0.31101 -0.365658 -0.246618
-3.6529 9.0717 0.772411 -0.314983 -13.759 1.79395 0.17073 0.0929223 -0.246705
7.23456 -1.27606 -6.50145 -7.40004 -8.50641 6.27078 -0.278275 -0.347707 -0.238637
3.24194 3.2851 8.65645 -4.43387 -11.2217 0.246533 -0.00838036 -0.176901 -0.272344
-0.451938 7.55882 -6.23668 -2.70621 -13.2022 6.88172 0.172645 -0.0204944 -0.268494
9.58834 -1.93603 0.742708 -8.26047 -8.39618 3.56466 -0.281499 -0.445928 -0.244877
-0.321458 8.55371 4.79237 -2.898 -13.5168 0.271125 0.173329 -0.0261996 -0.252466
5.35877 3.44264 -7.46109 -6.03255 -11.0641 7.3187 -0.0381496 -0.265818 -0.249635
7.40921 1.94737 6.12759 -6.98123 -10.4098 1.02199 -0.100234 -0.351474 -0.248707
0.279124 9.64183 -1.78696 -3.54281 -14.0518 3.49106 0.217126 -0.0505007 -0.246221
9.28495 1.19887 -2.93061 -8.01451 -10.0496 5.61156 -0.133212 -0.430874 -0.243059
4.0772 6.97433 5.56519 -5.53059 -12.7728 0.395822 0.101288 -0.211078 -0.239697
4.38399 7.23945 -4.96055 -5.66226 -12.9007 5.58066 0.115235 -0.222942 -0.241524
9.09181 3.08821 2.00948 -7.88606 -10.983 3.06945 -0.0542266 -0.421072 -0.241743
3.75484 8.98917 1.15417 -5.40208 -13.7427 2.31556 0.18346 -0.196218 -0.237465
7.64458 5.66914 -2.37849 -7.22387 -12.2068 4.84712 0.0507673 -0.35932 -0.240181
6.94465 6.92878 -0.0073961 -6.89179 -12.8094 3.47296 0.10245 -0.329777 -0.238428"""

    for line in data.split("\n"):
        data = [float(x) for x in line.strip().split(" ")]
        gravity = np.array(data[:3])
        ft_raw = np.array(data[3:])
        calib.add_measurement(gravity, ft_raw)

    # 执行最小二乘校准
    params = calib.get_calibration_raw()

    assert np.allclose(
        params,
        np.array(
            [
                4.76231835e-01,
                -4.18997239e-04,
                -5.57284579e-04,
                4.24162517e-02,
                -3.63265985e00,
                -9.21982189e00,
                2.91507091e00,
                -1.98254604e-01,
                -4.55049891e-02,
                -2.51303482e-01,
            ]
        ),
        atol=0,
        rtol=1e-8,
    )


if __name__ == "__main__":
    test_calib()
